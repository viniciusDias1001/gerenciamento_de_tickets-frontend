<div class="tickets-page">
  <div class="container">

    <div class="header">
      <div>
        <h1 class="mt-4">{{ headerTitle }}</h1>
        <ol class="breadcrumb mb-4 custom-breadcrumb">
          <li class="breadcrumb-item active">
            {{ headerSubtitle }}
          </li>
        </ol>
      </div>

      <div class="header-actions">
        <a class="btn btn-success" routerLink="/home/tickets/novo" *ngIf="canCreate">
          Novo Ticket
        </a>
      </div>
    </div>

    <div class="card filters-card">
      <div class="card-body">
        <form [formGroup]="form" (ngSubmit)="applyFilters()" class="filters">

          <div class="field">
            <label>Buscar</label>
            <input class="form-control" formControlName="q" placeholder="ID ou título..." />
          </div>

          <div class="field">
            <label>Status</label>
            <select class="form-control" formControlName="status">
              <option value="">Todos</option>
              <option value="OPEN">Aberto</option>
              <option value="IN_PROGRESS">Em andamento</option>
              <option value="DONE">Concluído</option>
            </select>
          </div>

          <div class="field">
            <label>Prioridade</label>
            <select class="form-control" formControlName="priority">
              <option value="">Todas</option>
              <option value="LOW">Baixa</option>
              <option value="MEDIUM">Média</option>
              <option value="HIGH">Alta</option>
            </select>
          </div>

          <div class="field small">
            <label>Por página</label>
            <select class="form-control" formControlName="size">
              <option [ngValue]="10">10</option>
              <option [ngValue]="20">20</option>
              <option [ngValue]="50">50</option>
            </select>
          </div>

          <div class="actions">
            <button class="btn btn-primary" type="submit" [disabled]="loading">
              Filtrar
            </button>

            <button class="btn btn-outline-secondary" type="button" (click)="clearFilters()" [disabled]="loading">
              Limpar
            </button>
          </div>

        </form>
      </div>
    </div>

    <div class="alert alert-danger" *ngIf="errorMsg">{{ errorMsg }}</div>

    <div class="card table-card">
      <div class="card-body">

        <div class="table-top">
          <div *ngIf="page" class="muted">
            Total: <b>{{ page.totalElements }}</b>
            • Página <b>{{ page.number + 1 }}</b> de <b>{{ page.totalPages }}</b>
          </div>

          <div class="muted" *ngIf="loading">Carregando...</div>
        </div>

       
        <div class="table-responsive desktop-only" *ngIf="page">
          <table class="table table-hover align-middle tickets-table">
            <thead>
              <tr>
                <th style="width: 160px;">#</th>
                <th>Título</th>
                <th style="width: 140px;">Status</th>
                <th style="width: 140px;">Prioridade</th>
                <th style="width: 200px;">Criado por</th>
                <th style="width: 200px;">Responsável</th>
                <th style="width: 170px;">Ações</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let t of page.content">
                <td class="mono">{{ t.id }}</td>

                <td>
                  <div class="title">
                    <a class="ticket-link" [routerLink]="['/home/tickets', t.id]">
                      {{ t.title }}
                    </a>
                  </div>
                  <div class="sub muted">
                    Atualizado: {{ t.updatedAt | date:'dd/MM/yyyy HH:mm' }}
                  </div>
                </td>

                <td>
                  <span class="badge-pill status"
                        [class.open]="t.status==='OPEN'"
                        [class.progress]="t.status==='IN_PROGRESS'"
                        [class.done]="t.status==='DONE'">
                    {{ statusLabel(t.status) }}
                  </span>
                </td>

                <td>
                  <span class="badge-pill priority"
                        [class.low]="t.priority==='LOW'"
                        [class.medium]="t.priority==='MEDIUM'"
                        [class.high]="t.priority==='HIGH'">
                    {{ priorityLabel(t.priority) }}
                  </span>
                </td>

                <td class="muted">{{ t.createdBy.name || '-' }}</td>
                <td class="muted">{{ t.assignedTo?.name || 'Não atribuído' }}</td>

                <td class="row-actions">
                  <a class="btn btn-sm btn-outline-secondary"
                     [routerLink]="['/home/tickets', t.id]">
                    Ver
                  </a>

                  <a class="btn btn-sm btn-outline-primary"
                     *ngIf="isAdmin || isTech"
                     [routerLink]="['/home/tickets', t.id, 'manage']">
                    Gerenciar
                  </a>

                  <button class="btn btn-sm btn-outline-danger"
                          *ngIf="isAdmin"
                          (click)="openDeleteConfirm(t)"
                          [disabled]="loading"
                          title="Excluir ticket">
                    Excluir
                  </button>
                </td>
              </tr>

              <tr *ngIf="page.content.length === 0">
                <td colspan="7" class="muted text-center py-4">
                  Nenhum ticket encontrado com os filtros atuais.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- MOBILE -->
        <div class="mobile-only" *ngIf="page">
          <div class="ticket-card-item" *ngFor="let t of page.content">

            <div class="card-top">
              <div class="card-title">
                <a class="ticket-link" [routerLink]="['/home/tickets', t.id]">
                  {{ t.title }}
                </a>
                <div class="sub muted"># {{ t.id }}</div>
              </div>

              <div class="pill-group">
                <span class="badge-pill status"
                      [class.open]="t.status==='OPEN'"
                      [class.progress]="t.status==='IN_PROGRESS'"
                      [class.done]="t.status==='DONE'">
                  {{ statusLabel(t.status) }}
                </span>

                <span class="badge-pill priority"
                      [class.low]="t.priority==='LOW'"
                      [class.medium]="t.priority==='MEDIUM'"
                      [class.high]="t.priority==='HIGH'">
                  {{ priorityLabel(t.priority) }}
                </span>
              </div>
            </div>

            <div class="card-meta">
              <div class="muted">Criado por: <b>{{ t.createdBy.name || '-' }}</b></div>
              <div class="muted">Resp.: <b>{{ t.assignedTo?.name || 'Não atribuído' }}</b></div>
              <div class="muted">Atualizado: <b>{{ t.updatedAt | date:'dd/MM/yyyy HH:mm' }}</b></div>
            </div>

            <div class="card-actions">
              <a class="btn btn-outline-secondary" [routerLink]="['/home/tickets', t.id]">Ver</a>

              <a class="btn btn-outline-primary" *ngIf="isAdmin || isTech"
                 [routerLink]="['/home/tickets', t.id, 'manage']">
                Gerenciar
              </a>

              <button class="btn btn-outline-danger" *ngIf="isAdmin"
                      (click)="openDeleteConfirm(t)" [disabled]="loading">
                Excluir
              </button>
            </div>

          </div>

          <div class="muted text-center py-4" *ngIf="page.content.length === 0">
            Nenhum ticket encontrado com os filtros atuais.
          </div>
        </div>

        <div class="pagination" *ngIf="page">
          <button class="btn btn-outline-secondary" (click)="prev()" [disabled]="page.first || loading">
            ◀ Anterior
          </button>

          <button class="btn btn-outline-secondary" (click)="next()" [disabled]="page.last || loading">
            Próxima ▶
          </button>
        </div>

      </div>
    </div>

  </div>
</div>


<div class="modal-backdrop" *ngIf="confirmOpen" (click)="confirmNo()"></div>

<div class="modal" *ngIf="confirmOpen" role="dialog" aria-modal="true">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <h3 class="modal-title">{{ confirmTitle }}</h3>
    <p class="modal-text">{{ confirmMessage }}</p>

    <div class="modal-actions">
      <button type="button" class="btn btn-outline-secondary" (click)="confirmNo()">Cancelar</button>
      <button type="button" class="btn btn-danger" (click)="confirmYes()">Excluir</button>
    </div>
  </div>
</div>
